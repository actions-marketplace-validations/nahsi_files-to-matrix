name: "Files to matrix"
description: "Generate github action build matrix from a list of files"
author: "Anatoly Laskaris"

inputs:
  files:
    description: "List of files to convert to matrix"
    required: true
  map:
    description: "Map of names to path levels"
    required: true
outputs:
  matrix:
    description: "Matrix generated from files"

runs:
  using: "composite"
  steps:
    - name: "Setup deno"
      uses: denoland/setup-deno@v1
      with:
        deno-version: v1.x

    - name: "Setup cache action"
      uses: actions/cache@v2
      with:
        path: "~/.deno"
        key: "${{ runner.os }}-deno-${{ hashFiles('$GITHUB_ACTION_PATH/import_map.json') }}"
        restore-keys: |
          ${{ runner.os }}-deno-files-to-matrix-${{ hashFiles('$GITHUB_ACTION_PATH/import_map.json') }}
          ${{ runner.os }}-deno-files-to-matrix-
          ${{ runner.os }}-deno-

    - name: "Run action with deno"
      shell: bash
      env:
        INPUT_FILES: ${{ inputs.files }}
        INPUT_MAP: ${{ inputs.map }}
      run: |
        deno run --quiet --unstable \
          --import-map $GITHUB_ACTION_PATH/import_map.json \
          --allow-env --allow-read \
          main.ts
